name: Backend CI

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-ci.yml'

jobs:
  # STAGE 1: Fast checks.
  # We group mod-check and lint because they are quick.
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: './backend/go.mod'
          cache-dependency-path: backend/go.sum
          cache: true # Uses native caching, removes need for manual cache step

      - name: Verify go.mod
        run: |
          go mod tidy
          git diff --exit-code go.mod go.sum

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: v1.63.4
          working-directory: ./backend
          args: --timeout=5m --out-format=colored-line-number

  # STAGE 2: Heavy Logic.
  # Depends on quality-gate passing.
  test-and-security:
    name: Test & Security
    needs: quality-gate # This creates the dependency
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: './backend/go.mod'
          cache-dependency-path: backend/go.sum
          cache: true

      # Combined Build & Test to save a VM spin-up
      - name: Run Tests (includes build)
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./backend/coverage.out
          flags: backend
        continue-on-error: true

      # Security scans run here. 
      # If tests fail, you might not care about security vulnerabilities yet.
      - name: Run Gosec
        uses: securego/gosec@master
        with:
          args: -no-fail -fmt sarif -out results.sarif ./...

  # STAGE 3: Packaging.
  # Only build Docker image if code is valid and secure.
  docker-build:
    name: Docker Build
    needs: test-and-security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: false
          tags: backend:test
          # Good job on these cache settings, keep them!
          cache-from: type=gha
          cache-to: type=gha,mode=max